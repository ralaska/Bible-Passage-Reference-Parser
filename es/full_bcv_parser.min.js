var u=class{constructor(e,t){this.parent=e,this.grammar=t}replace_control_characters(e){return e=e.replace(this.parent.regexps.control," "),this.parent.options.non_latin_digits_strategy==="replace"&&(e=e.replace(/[٠۰߀०০੦૦୦0౦೦൦๐໐༠၀႐០᠐᥆᧐᪀᪐᭐᮰᱀᱐꘠꣐꤀꧐꩐꯰０]/g,"0"),e=e.replace(/[١۱߁१১੧૧୧௧౧೧൧๑໑༡၁႑១᠑᥇᧑᪁᪑᭑᮱᱁᱑꘡꣑꤁꧑꩑꯱１]/g,"1"),e=e.replace(/[٢۲߂२২੨૨୨௨౨೨൨๒໒༢၂႒២᠒᥈᧒᪂᪒᭒᮲᱂᱒꘢꣒꤂꧒꩒꯲２]/g,"2"),e=e.replace(/[٣۳߃३৩੩૩୩௩౩೩൩๓໓༣၃႓៣᠓᥉᧓᪃᪓᭓᮳᱃᱓꘣꣓꤃꧓꩓꯳３]/g,"3"),e=e.replace(/[٤۴߄४৪੪૪୪௪౪೪൪๔໔༤၄႔៤᠔᥊᧔᪄᪔᭔᮴᱄᱔꘤꣔꤄꧔꩔꯴４]/g,"4"),e=e.replace(/[٥۵߅५৫੫૫୫௫౫೫൫๕໕༥၅႕៥᠕᥋᧕᪅᪕᭕᮵᱅᱕꘥꣕꤅꧕꩕꯵５]/g,"5"),e=e.replace(/[٦۶߆६৬੬૬୬௬౬೬൬๖໖༦၆႖៦᠖᥌᧖᪆᪖᭖᮶᱆᱖꘦꣖꤆꧖꩖꯶６]/g,"6"),e=e.replace(/[٧۷߇७৭੭૭୭௭౭೭൭๗໗༧၇႗៧᠗᥍᧗᪇᪗᭗᮷᱇᱗꘧꣗꤇꧗꩗꯷７]/g,"7"),e=e.replace(/[٨۸߈८৮੮૮୮௮౮೮൮๘໘༨၈႘៨᠘᥎᧘᪈᪘᭘᮸᱈᱘꘨꣘꤈꧘꩘꯸８]/g,"8"),e=e.replace(/[٩۹߉९৯੯૯୯௯౯೯൯๙໙༩၉႙៩᠙᥏᧙᪉᪙᭙᮹᱉᱙꘩꣙꤉꧙꩙꯹９]/g,"9")),e}match_books(e){let t=[];for(let s of this.parent.regexps.books){let n=!1;if(e=e.replace(s.regexp,function(r,a){n=!0,t.push({value:a,parsed:s.osis,type:"book"});let i=s.extra?`/${s.extra}`:"";return`${t.length-1}${i}`}),n&&/^[\s\x1f\d:.,;\-\u2013\u2014]+$/.test(e))break}for(let s of this.parent.regexps.translations)e=e.replace(s,function(n){return t.push({value:n,parsed:n.toLowerCase(),type:"translation"}),`${t.length-1}`});return[e,this.get_book_indices(t,e)]}get_book_indices(e,t){let s=0;for(let n of t.matchAll(/([\x1f\x1e])(\d+)(?:\/\d+)?\1/g)){let r=parseInt(n[2],10);e[r].start_index=n.index+s,s+=e[r].value.length-n[0].length}return e}match_passages(e){let t=[],s={};for(let n of e.matchAll(this.parent.regexps.escaped_passage)){let[r,a,i]=n,o=parseInt(i,10),l=a.length;n.index+=r.length-l,a=this.clean_end_match(e,n,a),a=a.replace(/[A-Z]+/g,x=>x.toLowerCase());let c=a.startsWith("")?0:a.split("")[0].length,_={value:this.grammar.parse(a,{punctuation_strategy:this.parent.options.punctuation_strategy}),type:"base",start_index:this.parent.passage.books[o].start_index-c,match:a},m=this.parent.passage.books[o].parsed;c===0&&this.parent.options.book_alone_strategy==="full"&&this.parent.options.book_range_strategy==="include"&&_.value[0].type==="b"&&Array.isArray(_.value)&&(_.value.length===1||_.value.length>1&&_.value[1].type==="translation_sequence")&&/^[234]/.test(m)&&this.create_book_range(e,_,o);let b=[];[b,s]=this.parent.passage.handle_obj(_,[],{}),t=t.concat(b);let v=this.adjust_regexp_end(b,l,a.length);v>0&&(this.parent.regexps.escaped_passage.lastIndex-=v)}return[t,s]}clean_end_match(e,t,s){if(/\s[2-9]\d\d\s*$|\s\d{4,}\s*$/.test(s)&&(s=s.replace(/\s+\d+\s*$/,"")),!/[\d\x1f\x1e)]$/.test(s)){let n=s.split(this.parent.regexps.match_end_split),r=n.pop();n.length>0&&r!=null&&r.length>0&&(s=s.substring(0,s.length-r.length))}if(this.parent.options.captive_end_digits_strategy==="delete"){let n=t.index+s.length;e.length>n&&/^\w/.test(e.charAt(n))&&(s=s.replace(/[\s*]+\d+$/,"")),s=s.replace(/(\x1e[)\]]?)[\s*]*\d+$/,"$1")}return s}adjust_regexp_end(e,t,s){return e.length>0?t-e[e.length-1].indices[1]-1:t!==s?t-s:0}create_book_range(e,t,s){let n=[this.parent.regexps.first,this.parent.regexps.second,this.parent.regexps.third],r=parseInt(this.parent.passage.books[s].parsed[0].substring(0,1),10);for(let a=1;a<r;a++){let i=a===r-1?this.parent.regexps.range_and:this.parent.regexps.range_only,o=new RegExp(String.raw`(?:^|[^\p{L}\p{N}])(${n[a-1]}\s*${i}\s*)\x1f${s}\x1f`,"iu"),l=e.match(o);if(l)return this.add_book_range_object(t,l,a)}return!1}add_book_range_object(e,t,s){let n=t[1].length;if(e.value[0]={type:"b_range_pre",value:[{type:"b_pre",value:s.toString(),indices:[t.index,t.index+n]},e.value[0]],indices:[0,e.value[0].indices[1]+n]},this.add_offset_to_indices(e.value[0].value[1].indices,n),e.start_index-=n,e.match=t[1]+e.match,!Array.isArray(e.value))return e;for(let r=1;r<e.value.length;r++)e.value[r].value&&(e.value[r].value[0]?.indices&&this.add_offset_to_indices(e.value[r].value[0].indices,n),this.add_offset_to_indices(e.value[r].indices,n));return e}add_offset_to_indices(e,t){e[0]+=t,e[1]+=t}};var p=class{constructor(e){this.consecutive_combination_strategy="combine";this.osis_compaction_strategy="b";this.book_sequence_strategy="ignore";this.invalid_sequence_strategy="ignore";this.sequence_combination_strategy="combine";this.punctuation_strategy="us";this.invalid_passage_strategy="ignore";this.non_latin_digits_strategy="ignore";this.passage_existence_strategy="bcv";this.book_alone_strategy="ignore";this.book_range_strategy="ignore";this.captive_end_digits_strategy="delete";this.ps151_strategy="c";this.zero_chapter_strategy="error";this.zero_verse_strategy="error";this.single_chapter_1_strategy="chapter";this.end_range_digits_strategy="verse";this.warn_level="none";this.#e="on";this.#t="none";this.parent=e}#e;get testaments(){return this.#e}set testaments(e){if(e===this.#e||e.length===0)return;let t=e.split(""),s="";if(t[0]==="o"&&(t.shift(),s+="o"),t.length>0&&t[0]==="n"&&(t.shift(),s+="n"),t.length>0&&t[0]==="a"&&(s+="a"),s.length>0&&s!==this.#e){let n=s.indexOf("a")>=0,r=this.#e.indexOf("a")>=0;this.#e=s,n!==r?this.set_apocrypha(n):this.parent.regexps_manager.filter_books(this.#e,this.case_sensitive)}}set_apocrypha(e){this.parent.regexps_manager.filter_books(this.#e,this.case_sensitive);for(let t of Object.keys(this.parent.translations.systems))this.parent.translations.systems[t].chapters??={},this.parent.translations.systems[t].chapters.Ps??=[...this.parent.translations.systems.current.chapters.Ps],e===!0?this.parent.translations.systems[t].chapters.Ps[150]=this.parent.translations.systems[t].chapters.Ps151?.[0]??this.parent.translations.systems.current.chapters.Ps151[0]:this.parent.translations.systems[t].chapters?.Ps.length===151&&this.parent.translations.systems[t].chapters.Ps.pop()}get versification_system(){return this.parent.translations.current_system}set versification_system(e){this.parent.translations.aliases[e]?.system&&(e=this.parent.translations.aliases[e].system),this.parent.translations.systems[e]||(this.warn_level==="warn"&&console.warn(`Unknown versification system ("${e}"). Using default instead.`),e="default"),!(!e||e===this.parent.translations.current_system)&&(this.parent.translations.current_system!=="default"&&(this.parent.translations.systems.current=structuredClone(this.parent.translations.systems.default)),this.parent.translations.current_system=e,e!=="default"&&(this.parent.translations.systems[e].order&&(this.parent.translations.systems.current.order={...this.parent.translations.systems[e].order}),this.parent.translations.systems[e].chapters&&(this.parent.translations.systems.current.chapters={...structuredClone(this.parent.translations.systems.default.chapters),...structuredClone(this.parent.translations.systems[e].chapters)})))}#t;get case_sensitive(){return this.#t}set case_sensitive(e){e===this.#t||e!=="none"&&e!=="books"||(this.#t=e,this.parent.regexps_manager.filter_books(this.testaments,e))}};var f=class{constructor(e,t){this.books=[];this.indices=[];this.options=e,this.translations=t}handle_array(e,t=[],s={}){for(let n of e)n!=null&&([t,s]=this.handle_obj(n,t,s));return[t,s]}handle_obj(e,t,s){return e.type&&typeof this[e.type]=="function"?this[e.type](e,t,s):[t,s]}b(e,t,s){e.start_context=structuredClone(s),e.passages=[];let n=[];for(let r of this.books[e.value].parsed){let a=this.validate_ref(e.start_context.translations,{b:r}),i={start:{b:r},end:{b:r},valid:a};e.passages.length===0&&a.valid?e.passages.push(i):n.push(i)}return this.normalize_passage_and_alternates(e,n),t.push(e),s={b:e.passages[0].start.b},e.start_context.translations&&(s.translations=structuredClone(e.start_context.translations)),[t,s]}b_pre(e,t,s){return[t,s]}b_range(e,t,s){return this.range(e,t,s)}b_range_pre(e,t,s){e.start_context=structuredClone(s),e.passages=[];let n=this.pluck("b",e.value),r;return[[r],s]=this.b(n,[],s),e.absolute_indices??=this.get_absolute_indices(e.indices),e.passages=[{start:{b:e.value[0].value+r.passages[0].start.b.substring(1),type:"b"},end:r.passages[0].end,valid:r.passages[0].valid}],e.start_context.translations&&(e.passages[0].translations=structuredClone(e.start_context.translations)),t.push(e),[t,s]}b_range_start(e,t,s){return this.range(e,t,s)}base(e,t,s){return this.indices=this.calculate_indices(e.match,e.start_index),this.handle_array(e.value,t,s)}bc(e,t,s){e.start_context=structuredClone(s),e.passages=[],this.reset_context(s,["b","c","v"]);let n=this.pluck("c",e.value).value,r=[];for(let a of this.books[this.pluck("b",e.value).value].parsed){let i="c",o=this.validate_ref(e.start_context.translations,{b:a,c:n}),l={start:{b:a},end:{b:a},valid:o};(o.messages?.start_chapter_not_exist_in_single_chapter_book||o.messages?.start_chapter_1)&&(l.valid=this.validate_ref(e.start_context.translations,{b:a,v:n}),o.messages?.start_chapter_not_exist_in_single_chapter_book&&(l.valid.messages.start_chapter_not_exist_in_single_chapter_book=1),l.start.c=1,l.end.c=1,i="v"),l.start[i]=n,[l.start.c,l.start.v]=this.fix_start_zeroes(l.valid,l.start.c,l.start.v),l.start.v==null&&delete l.start.v,l.end[i]=l.start[i],e.passages.length===0&&l.valid.valid?e.passages.push(l):r.push(l)}return this.normalize_passage_and_alternates(e,r),this.set_context_from_object(s,["b","c","v"],e.passages[0].start),t.push(e),[t,s]}bc_title(e,t,s){e.start_context=structuredClone(s);let n=this.pluck("bc",e.value),r;if([[r],s]=this.bc(n,[],s),r.passages[0].start.b.substring(0,2)!=="Ps"&&r.passages[0].alternates){for(let i of r.passages[0].alternates)if(i.start.b.substring(0,2)==="Ps"){r.passages[0]=structuredClone(i);break}}if(r.passages[0].start.b.substring(0,2)!=="Ps")return t.push(r),[t,s];this.books[this.pluck("b",r.value).value].parsed=["Ps"];let a=this.pluck("title",e.value);return a||(a=this.pluck("v",e.value)),e.value[1]={type:"v",original_type:"title",value:[{type:"integer",value:1,indices:a.indices}],indices:a.indices},e.type="bcv",this.bcv(e,t,e.start_context)}bcv(e,t,s){e.start_context=structuredClone(s),e.passages=[],this.reset_context(s,["b","c","v"]);let n=this.pluck("bc",e.value),r=this.pluck("c",n.value).value,a=this.pluck("v",e.value).value,i=[];for(let o of this.books[this.pluck("b",n.value).value].parsed){let l=this.validate_ref(e.start_context.translations,{b:o,c:r,v:a});[r,a]=this.fix_start_zeroes(l,r,a);let c={start:{b:o,c:r,v:a},end:{b:o,c:r,v:a},valid:l};e.passages.length===0&&l.valid?e.passages.push(c):i.push(c)}return this.normalize_passage_and_alternates(e,i),this.set_context_from_object(s,["b","c","v"],e.passages[0].start),t.push(e),[t,s]}bv(e,t,s){e.start_context=structuredClone(s);let[n,r]=e.value,a={indices:e.indices,value:[{type:"bc",value:[n,{type:"c",value:[{type:"integer",value:1}]}]},r]};return[[a],s]=this.bcv(a,[],s),e.passages=a.passages,e.absolute_indices??=this.get_absolute_indices(e.indices),t.push(e),[t,s]}c(e,t,s){e.start_context=structuredClone(s);let n=e.type==="integer"?e.value:this.pluck("integer",e.value).value,r=this.validate_ref(e.start_context.translations,{b:s.b,c:n});return!r.valid&&r.messages?.start_chapter_not_exist_in_single_chapter_book?this.v(e,t,s):([n]=this.fix_start_zeroes(r,n),e.passages=[{start:{b:s.b,c:n},end:{b:s.b,c:n},valid:r}],e.start_context.translations&&(e.passages[0].translations=e.start_context.translations),t.push(e),s.c=n,this.reset_context(s,["v"]),e.absolute_indices??=this.get_absolute_indices(e.indices),[t,s])}c_psalm(e,t,s){e.type="bc";let n=parseInt(this.books[e.value].value.match(/^\d+/)[0],10);return e.value=[{type:"b",value:e.value,indices:e.indices},{type:"c",value:[{type:"integer",value:n,indices:e.indices}],indices:e.indices}],this.bc(e,t,s)}c_title(e,t,s){if(e.start_context=structuredClone(s),s.b!=="Ps")return this.c(e.value[0],t,s);let n=this.pluck("title",e.value);return e.value[1]={type:"v",original_type:"title",value:[{type:"integer",value:1,indices:n.indices}],indices:n.indices},e.type="cv",this.cv(e,t,e.start_context)}cb_range(e,t,s){e.type="range";let[n,r,a]=e.value;return e.value=[{type:"bc",value:[n,r],indices:e.indices},a],a.indices[1]=e.indices[1],this.range(e,t,s)}context(e,t,s){return e.start_context=structuredClone(s),e.passages=[],s=Object.assign(s,this.books[e.value].context),t.push(e),[t,s]}cv(e,t,s){e.start_context=structuredClone(s);let n=this.pluck("c",e.value).value,r=this.pluck("v",e.value).value,a=this.validate_ref(e.start_context.translations,{b:s.b,c:n,v:r});return[n,r]=this.fix_start_zeroes(a,n,r),e.passages=[{start:{b:s.b,c:n,v:r},end:{b:s.b,c:n,v:r},valid:a}],e.start_context.translations&&(e.passages[0].translations=e.start_context.translations),e.absolute_indices??=this.get_absolute_indices(e.indices),s.c=n,s.v=r,t.push(e),[t,s]}cv_psalm(e,t,s){e.start_context=structuredClone(s),e.type="bcv";let[n,r]=e.value,[[a]]=this.c_psalm(n,[],e.start_context);return e.value=[a,r],this.bcv(e,t,s)}ff(e,t,s){e.start_context=structuredClone(s),e.value.push({type:"integer",indices:structuredClone(e.indices),value:999}),[[e],s]=this.range(e,[],e.start_context),e.value[0].indices=e.value[1].indices,e.value[0].absolute_indices=e.value[1].absolute_indices,e.value.pop();for(let n of["end_verse_not_exist","end_chapter_not_exist"])delete e.passages[0].valid.messages[n];return t.push(e),[t,s]}integer(e,t,s){return s.v==null?this.c(e,t,s):this.v(e,t,s)}integer_title(e,t,s){return e.start_context=structuredClone(s),s.b!=="Ps"?this.integer(e.value[0],t,s):(e.value[0]={type:"c",value:[e.value[0]],indices:structuredClone(e.value[0].indices)},e.value[1].type="v",e.value[1].original_type="title",e.value[1].value=[{type:"integer",value:1,indices:structuredClone(e.value[1].value.indices)}],e.type="cv",this.cv(e,t,e.start_context))}next_v(e,t,s){e.start_context=structuredClone(s);let n=this.pluck_last_recursively("integer",e.value)??{value:1};e.value.push({type:"integer",indices:e.indices,value:n.value+1});let r;[[r],s]=this.range(e,[],e.start_context),r.passages[0].valid.messages.end_verse_not_exist&&!r.passages[0].valid.messages.start_verse_not_exist&&!r.passages[0].valid.messages.start_chapter_not_exist&&s.c!=null&&(e.value.pop(),e.value.push({type:"cv",indices:e.indices,value:[{type:"c",value:[{type:"integer",value:s.c+1,indices:e.indices}],indices:e.indices},{type:"v",value:[{type:"integer",value:1,indices:e.indices}],indices:e.indices}]}),[[r],s]=this.range(e,[],e.start_context)),r.value[0].indices=r.value[1].indices,r.value[0].absolute_indices=r.value[1].absolute_indices,r.value.pop();for(let a of["end_verse_not_exist","end_chapter_not_exist"])delete e.passages[0].valid.messages[a];return t.push(r),[t,s]}sequence(e,t,s){e.start_context=structuredClone(s),e.passages=[];for(let n of e.value){let r;[[r],s]=this.handle_array(n,[],s);for(let a of r.passages)a.type??=r.type,a.absolute_indices??=r.absolute_indices,r.start_context.translations&&(a.translations=r.start_context.translations),a.enclosed_absolute_indices=r.type==="sequence_post_enclosed"?[...r.absolute_indices]:[-1,-1],e.passages.push(a)}return e.absolute_indices||(e.passages.length>0&&e.type==="sequence"?e.absolute_indices=[e.passages[0].absolute_indices[0],e.passages[e.passages.length-1].absolute_indices[1]]:e.absolute_indices=this.get_absolute_indices(e.indices)),t.push(e),[t,s]}sequence_post_enclosed(e,t,s){return this.sequence(e,t,s)}v(e,t,s){e.start_context=structuredClone(s);let n=e.type==="integer"?e.value:this.pluck("integer",e.value).value,r=s.c!=null?s.c:1,a=this.validate_ref(e.start_context.translations,{b:s.b,c:r,v:n}),[,i]=this.fix_start_zeroes(a,0,n);return e.passages=[{start:{b:s.b,c:r,v:i},end:{b:s.b,c:r,v:i},valid:a}],e.start_context.translations&&(e.passages[0].translations=structuredClone(e.start_context.translations)),e.absolute_indices??=this.get_absolute_indices(e.indices),t.push(e),s.v=i,[t,s]}range(e,t,s){e.start_context=structuredClone(s);let[n,r]=e.value;if([[n],s]=this.handle_obj(n,[],s),r.type==="v"&&this.options.end_range_digits_strategy==="verse"&&(n.type==="bc"&&!n.passages?.[0]?.valid?.messages?.start_chapter_not_exist_in_single_chapter_book||n.type==="c"))return e.value[0]=n,this.range_change_integer_end(e,t);[[r],s]=this.handle_obj(r,[],s),e.value=[n,r],e.indices=[n.indices[0],r.indices[1]],delete e.absolute_indices;let a={b:n.passages[0].start.b,c:n.passages[0].start.c,v:n.passages[0].start.v,type:n.type},i={b:r.passages[0].end.b,c:r.passages[0].end.c,v:r.passages[0].end.v,type:r.type};r.passages[0].valid.messages.start_chapter_is_zero&&(i.c=0),r.passages[0].valid.messages.start_verse_is_zero&&(i.v=0);let o=this.validate_ref(e.start_context.translations,a,i);if(o.valid){let[l,c]=this.range_handle_valid(o,e,n,a,r,i,t);if(l)return c}else return this.range_handle_invalid(o,e,n,a,r,i,t);return e.absolute_indices??=this.get_absolute_indices(e.indices),e.passages=[{start:a,end:i,valid:o}],e.start_context.translations&&(e.passages[0].translations=structuredClone(e.start_context.translations)),a.type==="b"?e.type=i.type==="b"?"b_range":"b_range_start":i.type==="b"&&(e.type="range_end_b"),t.push(e),[t,s]}range_change_end(e,t,s){let[n,r]=e.value;if(r.type==="integer")r.original_value=r.value,r.value=s;else if(r.type==="v"){let a=this.pluck("integer",r.value);a.original_value=a.value,a.value=s}else if(r.type==="cv"){let a=this.pluck("c",r.value);a.original_value=a.value,a.value=s}return this.handle_obj(e,t,e.start_context)}range_change_integer_end(e,t){let[s,n]=e.value;return e.original_type??=e.type,e.original_value??=[s,n],e.type=s.type==="integer"?"cv":s.type+"v",s.type==="integer"&&(e.value[0]={type:"c",value:[s],indices:s.indices}),n.type==="integer"&&(e.value[1]={type:"v",value:[n],indices:n.indices}),this.handle_obj(e,t,e.start_context)}range_check_new_end(e,t,s,n){let r=0,a;if(n.messages?.end_chapter_before_start)a="c";else if(n.messages?.end_verse_before_start)a="v";else return r;if(r=this.range_get_new_end_value(t,s,n,a),r>0){let i={b:s.b,c:s.c,v:s.v};i[a]=r,this.validate_ref(e,i).valid||(r=0)}return r}range_end_b(e,t,s){return this.range(e,t,s)}range_get_new_end_value(e,t,s,n){let r=0;return n==="c"&&s.messages?.end_chapter_is_zero||n==="v"&&s.messages?.end_verse_is_zero||(e[n]>=10&&t[n]<10&&e[n]-10*Math.floor(e[n]/10)<t[n]?r=t[n]+10*Math.floor(e[n]/10):e[n]>=100&&t[n]<100&&e[n]-100<t[n]&&(r=t[n]+100)),r}range_handle_invalid(e,t,s,n,r,a,i){if(e.valid===!1&&(e.messages?.end_chapter_before_start||e.messages?.end_verse_before_start)&&(r.type==="integer"||r.type==="v")||e.valid===!1&&e.messages?.end_chapter_before_start&&r.type==="cv"){let o=this.range_check_new_end(t.start_context.translations,n,a,e);if(o>0)return this.range_change_end(t,i,o)}if(this.options.end_range_digits_strategy==="verse"&&n.v==null&&(r.type==="integer"||r.type==="v")){let o=r.type==="v"?this.pluck("integer",r.value):r.value;if(this.validate_ref(t.start_context.translations,{b:n.b,c:n.c,v:o}).valid)return this.range_change_integer_end(t,i)}return t.original_type??=t.type,t.type="sequence",[t.original_value,t.value]=[[s,r],[[s],[r]]],this.sequence(t,i,structuredClone(t.start_context))}range_handle_valid(e,t,s,n,r,a,i){if(e.messages?.end_chapter_not_exist&&this.options.end_range_digits_strategy==="verse"&&!n.v&&(r.type==="integer"||r.type==="v")&&this.options.passage_existence_strategy.indexOf("v")>=0){let o=r.type==="v"?this.pluck("integer",r.value):r.value;if(this.validate_ref(t.start_context.translations,{b:n.b,c:n.c,v:o}).valid)return[!0,this.range_change_integer_end(t,i)]}return this.range_validate(e,n,a,t),[!1,null]}range_validate(e,t,s,n){e.messages?.end_chapter_not_exist||e.messages?.end_chapter_not_exist_in_single_chapter_book?(s.c=e.messages.end_chapter_not_exist??e.messages.end_chapter_not_exist_in_single_chapter_book,s.v!=null&&(s.v=this.validate_ref(n.start_context.translations,{b:s.b,c:s.c,v:999}).messages.end_verse_not_exist,delete e.messages.end_verse_is_zero)):e.messages?.end_verse_not_exist&&(s.v=e.messages.end_verse_not_exist),e.messages?.end_verse_is_zero&&this.options.zero_verse_strategy!=="allow"&&(s.v=e.messages.end_verse_is_zero),e.messages?.end_chapter_is_zero&&(s.c=e.messages.end_chapter_is_zero),[t.c,t.v]=this.fix_start_zeroes(e,t.c,t.v)}stop(e,t,s){return e.start_context={},t.push(e),[t,{}]}translation_sequence(e,t,s){e.start_context=structuredClone(s);let n=[];n.push({translation:this.books[e.value[0].value].parsed,system:"default",osis:""});for(let r of e.value[1]){let a=this.books[this.pluck("translation",r).value].parsed;a&&n.push({translation:a,system:"default",osis:""})}for(let r of n)this.translations.aliases[r.translation]?(r.system=this.translations.aliases[r.translation].system,r.osis=this.translations.aliases[r.translation].osis||r.translation.toUpperCase()):r.osis=r.translation.toUpperCase();return t.length>0&&(s=this.translation_sequence_apply(t,n)),e.absolute_indices=this.get_absolute_indices(e.indices),t.push(e),this.reset_context(s,["translations"]),[t,s]}translation_sequence_apply(e,t){let s=0;for(let r=e.length-1;r>=0;r--)if(e[r].original_type&&(e[r].type=e[r].original_type),e[r].original_value&&(e[r].value=e[r].original_value),e[r].type==="translation_sequence"||e[r].type==="stop"){s=r+1;break}let n;return s<e.length?(e[s].start_context.translations=t,[,n]=this.handle_array(e.slice(s),[],e[s].start_context)):n=structuredClone(e[e.length-1].start_context),n}word(e,t,s){return[t,s]}pluck(e,t){for(let s of t)if(s&&s.type&&s.type===e)return e==="c"||e==="v"?this.pluck("integer",s.value):s;return null}pluck_last_recursively(e,t){for(let s=t.length-1;s>=0;s--){let n=t[s];if(!n||!n.type)continue;if(n.type===e)return this.pluck(e,[n]);let r=this.pluck_last_recursively(e,n.value);if(r!=null)return r}return null}set_context_from_object(e,t,s){for(let n of t)s[n]!=null&&(e[n]=s[n])}reset_context(e,t){for(let s of t)delete e[s]}fix_start_zeroes(e,t,s=void 0){return e.messages?.start_chapter_is_zero&&this.options.zero_chapter_strategy==="upgrade"&&(t=e.messages.start_chapter_is_zero),e.messages?.start_verse_is_zero&&this.options.zero_verse_strategy==="upgrade"&&(s=e.messages.start_verse_is_zero),[t,s]}calculate_indices(e,t){let s="book",n=[],r=0;typeof t!="number"&&(t=parseInt(t,10));for(let a of e.split(/[\x1e\x1f]/)){s=s==="book"?"rest":"book";let i=a.length;if(i!==0)if(s==="book"){let o=parseInt(a.replace(/\/\d+$/,""),10),l=r+i;n.length>0&&n[n.length-1].index===t?n[n.length-1].end=l:n.push({start:r,end:l,index:t}),r+=i+2,t=this.books[o].start_index+this.books[o].value.length-r,n.push({start:l+1,end:l+1,index:t})}else{let o=r+i-1;n.length>0&&n[n.length-1].index===t?n[n.length-1].end=o:n.push({start:r,end:o,index:t}),r+=i}}return n}get_absolute_indices([e,t]){let s=null,n=null;for(let r of this.indices)if(s===null&&r.start<=e&&e<=r.end&&(s=e+r.index),r.start<=t&&t<=r.end){n=t+r.index+1;break}return[s,n]}normalize_passage_and_alternates(e,t){e.passages.length===0&&e.passages.push(t.shift()),t.length>0&&(e.passages[0].alternates=t),e.start_context.translations&&(e.passages[0].translations=e.start_context.translations),e.absolute_indices??=this.get_absolute_indices(e.indices)}validate_ref(e,t,s=null){(!e||e.length===0||!Array.isArray(e))&&(e=[{osis:"",translation:"current",system:"current"}]);let n=!1,r={};for(let a of e){if(!a.system){r.translation_invalid??=[],r.translation_invalid.push(a);continue}this.translations.aliases[a.system]||(a.system="current",r.translation_unknown??=[],r.translation_unknown.push(a));let[i]=this.validate_start_ref(a.system,t,r);s&&([i]=this.validate_end_ref(a.system,t,s,i,r)),i===!0&&(n=!0)}return{valid:n,messages:r}}validate_end_ref(e,t,s,n,r){let a=this.translations.systems[e]?.order?e:"current";return s.c===0&&(r.end_chapter_is_zero=1,this.options.zero_chapter_strategy==="error"?n=!1:s.c=1),s.v===0&&(r.end_verse_is_zero=1,this.options.zero_verse_strategy==="error"?n=!1:this.options.zero_verse_strategy==="upgrade"&&(s.v=1)),s.b&&this.translations.systems[a].order[s.b]?n=this.validate_known_end_book(e,a,t,s,n,r):(n=!1,r.end_book_not_exist=!0),[n,r]}validate_known_end_book(e,t,s,n,r,a){let i=this.translations.systems[e]?.chapters?.[n.b]||this.translations.systems.current.chapters[n.b];return n.c==null&&i.length===1&&(n.c=1),this.translations.systems[t].order[s.b]!=null&&this.translations.systems[t].order[s.b]>this.translations.systems[t].order[n.b]&&(this.options.passage_existence_strategy.indexOf("b")>=0&&(r=!1),a.end_book_before_start=!0),s.b===n.b&&n.c!=null&&(s.c??=1,s.c>n.c?(r=!1,a.end_chapter_before_start=!0):s.c===n.c&&n.v!=null&&(s.v??=1,s.v>n.v&&(r=!1,a.end_verse_before_start=!0))),n.c!=null&&i[n.c-1]==null&&(i.length===1?a.end_chapter_not_exist_in_single_chapter_book=1:n.c>0&&this.options.passage_existence_strategy.indexOf("c")>=0&&(a.end_chapter_not_exist=i.length)),n.v!=null&&(n.c??=i.length,n.v>i[n.c-1]&&this.options.passage_existence_strategy.indexOf("v")>=0&&(a.end_verse_not_exist=i[n.c-1])),r}validate_known_start_book(e,t,s){let n=!0;t.c??=1;let r=this.translations.systems[e]?.chapters?.[t.b]||this.translations.systems.current.chapters[t.b];if(t.c===0&&(s.start_chapter_is_zero=1,this.options.zero_chapter_strategy==="error"?n=!1:t.c=1),t.v===0&&(s.start_verse_is_zero=1,this.options.zero_verse_strategy==="error"?n=!1:this.options.zero_verse_strategy==="upgrade"&&(t.v=1)),t.c>0&&r[t.c-1]!=null)t.v!=null?t.v>r[t.c-1]&&this.options.passage_existence_strategy.indexOf("v")>=0&&(n=!1,s.start_verse_not_exist=r[t.c-1]):t.c===1&&this.options.single_chapter_1_strategy==="verse"&&r.length===1&&(s.start_chapter_1=1);else{let a=r.length;t.c!==1&&a===1?(n=!1,s.start_chapter_not_exist_in_single_chapter_book=1):t.c>0&&this.options.passage_existence_strategy.indexOf("c")>=0&&(n=!1,s.start_chapter_not_exist=a)}return n}validate_start_ref(e,t,s){let n=!0,r=this.translations.systems[e]?.order?e:"current";return t.b?this.translations.systems[r].order[t.b]?n=this.validate_known_start_book(e,t,s):(this.options.passage_existence_strategy.indexOf("b")>=0&&(n=!1),s.start_book_not_exist=!0):(n=!1,s.start_book_not_defined=!0),[n,s]}};var d=class{constructor(e){this.filtered_books_flags="";this.parent=e,this.filter_books("on","none")}filter_books(e,t){let s=e+"/"+t;s!==this.filtered_books_flags&&(this.filtered_books_flags=s,e==="ona"&&t==="none"&&(this.parent.regexps.books=this.parent.regexps.all_books),this.parent.regexps.books=this.parent.regexps.all_books.reduce((n,r)=>{let a;if(e!=="ona"&&e.indexOf(r.testament)===-1){if(r.testament.length===1||r.testament_books==null)return n;if(this.has_testament_overlap(e,r.testament)){let i=this.get_testament_overlap(e,r);if(i.length>0)a=structuredClone(r),a.osis=i;else return n}else return n}if(t==="books"){a??=structuredClone(r);let i=a.regexp.flags.replace("i","");a.regexp=new RegExp(r.regexp.source,i)}return n.push(a??r),n},[]))}has_testament_overlap(e,t){return new Set((e+t).split("")).size<e.length+t.length}get_testament_overlap(e,t){return t.osis.filter(n=>this.has_testament_overlap(e,t.testament_books[n]))}add_books(e){if(e==null||!Array.isArray(e.books))throw new Error("add_books: The argument to `add_books` should be an object with an array in `books`");for(let t of e.books){if(t==null||!(t.regexp instanceof RegExp))throw new Error("add_books: The `regexp` property of each pattern should be a RegExp");let s=this.get_book_testaments(t),n=this.get_book_pattern_regexps(t,s),r=new RegExp(n.pre_regexp.source+n.regexp.source+n.post_regexp.source,"giu"),a=typeof t.insert_at=="string"?t.insert_at:"start",i={osis:t.osis,testament:s.testament,regexp:r};if(s.testament.length>1&&(i.testament_books=s.testament_books),a==="start")this.parent.regexps.all_books.unshift(i);else if(a==="end")this.parent.regexps.all_books.push(i);else{let o=!1;for(let[l,c]of this.parent.regexps.all_books.entries())if(c.osis.join(",")===a){this.parent.regexps.all_books.splice(l,0,i),o=!0;break}o===!1&&this.parent.regexps.all_books.push(i)}}this.filtered_books_flags="",this.filter_books(this.parent.options.testaments,this.parent.options.case_sensitive)}get_book_pattern_regexps(e,t){let s={pre_regexp:new RegExp(""),regexp:e.regexp,post_regexp:new RegExp("")};for(let n of["pre_regexp","post_regexp"])if(e[n]==null){let r=n==="pre_regexp"?"pre_book":"post_book";t.has_number_book&&r==="pre_book"&&(r="pre_number_book"),s[n]=this.parent.regexps[r]}else if(e[n]instanceof RegExp)s[n]=e[n];else throw new Error("add_books: The `"+n+"` property of each pattern should be a RegExp");return s}get_book_testaments(e){let t=e.osis;if(!Array.isArray(t))throw new Error("add_books: The `osis` property of each pattern should be an array");let s={testament_books:{},has_number_book:!1,testament:""},n=new Set;for(let r of t){if(typeof r!="string"||this.parent.translations.systems.default.order[r]==null)throw new Error("add_books: Unknown book in pattern: "+r);if(r in s.testament_books)throw new Error("add_books: Every provided book should be unique. Duplicate: "+r);let a="o";if(r==="Ps")s.testament_books[r]="oa",n.add("o"),n.add("a");else{let i=this.parent.translations.systems.default.order[r];i>=40&&(a=i<=66?"n":"a"),/^\d/.test(r)&&/\d/.test(e.regexp.source)&&(s.has_number_book=!0),s.testament_books[r]=a,n.add(a)}}if(n.size===1)s.testament=n.values().next().value;else for(let r of["o","n","a"])n.has(r)&&(s.testament+=r);return s}};var g=class{constructor(e){this.parent=e}translation_info(e="default"){(typeof e!="string"||!e)&&(e="default"),this.parent.translations.aliases[e]?.system&&(e=this.parent.translations.aliases[e].system),this.parent.translations.systems[e]==null&&(this.parent.options.warn_level==="warn"&&console.warn("Unknown translation `"+new_translation+"` in translation_info(). Using default instead."),e="default");let t=this.parent.options.versification_system;this.parent.options.versification_system=e;let s={alias:e,books:[],chapters:structuredClone(this.parent.translations.systems.current.chapters),order:structuredClone(this.parent.translations.systems.current.order),system:e};for(let[n,r]of Object.entries(s.order))s.books[r-1]=n;return e!==t&&(this.parent.options.versification_system=t),s}add_translations(e){if(e?.translations==null||!Array.isArray(e.translations)||e.translations.length===0)throw new Error("add_translations: A `translations array in the `translations` key should have at least one object");let t={},s=[];for(let n of e.translations){let r=this.normalize_sent_translation_data(n),a=n.text.toLowerCase();if(t[a]!=null||this.parent.translations.aliases[a]!=null){this.parent.options.warn_level==="warn"&&console.warn("add_translations: Not redefining `"+n.text+"` translation because it already exists");continue}let i=r.system;if(i!=="default"&&this.parent.translations.systems[r.system]==null)if(e.systems!=null&&e.systems[i]!=null)this.add_system(r.system,e.systems[i]);else throw new Error("add_translations: Unknown translation `system`: `"+i+"`. Valid `system`s are: `"+Object.keys(this.parent.translations.systems).join("`, `")+"`. You may want to check that you included this system in `systems`");s.push(n.text),t[a]=r}s.length>0&&this.add_new_translations_regexp(s,e),this.parent.translations.aliases={...t,...this.parent.translations.aliases}}normalize_sent_translation_data(e){let t=e.text;if(t==null||typeof t!="string"||t.length===0)throw new Error('add_translations: Each translation object should contain a string `text` key with a value like "KJV"');if(t.match(/^\p{N}+$/u))throw new Error("add_translations: A translation.text (`"+t+"`) can't be all numbers because then it would conflict with chapter and verse references.");let s=typeof e.osis=="string"&&e.osis!==""?e.osis:e.text.toUpperCase(),n=typeof e.system=="string"&&e.system.length>0?e.system:"default";return{osis:s,system:n}}add_system(e,t){if(e==="default"||e==="current")throw new Error("add_translations: Can't use `"+e+"` as a versification system. This built-in system can't be redefined");if(t==null||t.books==null&&t.chapters==null)throw new Error("add_translations: The system object should contain `books` key, a `chapters` key or both");if(this.parent.translations.systems[e]!=null)return;let s={};if(t.books!=null){if(!Array.isArray(t.books)||t.books.length===0)throw new Error("add_translations: The `books` key in each `system` object should be an array with at least one string in it");s.books=this.make_system_books(t.books)}if(t.chapters!=null){if(typeof t.chapters!="object"||Object.keys(t.chapters).length===0)throw new Error("add_translations: The `chapters` key in the each `system` object should be an object with at least one key");this.validate_system_chapters(t.chapters),s.chapters=structuredClone(t.chapters)}this.parent.translations.systems[e]=s}make_system_books(e){let t=structuredClone(this.parent.translations.systems.default.order),s={},n=1;for(let a of e){if(typeof a!="string"||t[a]==null)throw new Error("add_translations: Got an unexpected OSIS value in `books` (also check for any duplicates): "+a);delete t[a],s[a]=n,n++}let r=Object.keys(t).sort((a,i)=>t[a]-t[i]);for(let a of r)s[a]=n,n++;return s}validate_system_chapters(e){let t=this.parent.translations.systems.default.order;for(let[s,n]of Object.entries(e)){if(t[s]==null)throw new Error("add_translations: Unexpected book: "+s);if(!Array.isArray(n)||n.length==0)throw new Error("add_translations: Each value in `chapters` should be an array with at least one entry containing the number of verses in each chapter. Check `"+s+"`");for(let r of n)if(!(typeof r=="number"&&r>=1&&r<=200))throw new Error("add_translations: Unexpected value in `chapters`: "+r+"`. It should be a number between 1 and 200")}}add_new_translations_regexp(e,t){e.length>1&&(e=e.sort((i,o)=>o.length-i.length));let s=t.insert_at==="end"?"end":"start",n=t?.pre_regexp instanceof RegExp?t?.pre_regexp:{source:""},r=t?.post_regexp instanceof RegExp?t?.post_regexp:/(?![\p{L}\p{N}])/u,a=new RegExp(n.source+"("+e.map(i=>i.replace(/([$\\.*+?()\[\]{}|^])/g,"\\$1")).join("|")+")"+r.source,"gi");s==="start"?this.parent.regexps.translations.unshift(a):this.parent.regexps.translations.push(a)}};var y=class{constructor(e=null){this.passage=new f;this.entities=[];if(this.options=new p(this),e==null){if(typeof grammar>"u")throw`When creating a new bcv_parser object using ES Modules, please provide a language object. For example, here's how to provide English:
import * as lang from "es/lang/en.js";
const bcv = new bcv_parser(lang);`;this.translations=new bcv_translations,this.matcher=new u(this,grammar),this.regexps=new bcv_regexps,this.translations=new bcv_translations}else this.matcher=new u(this,e.grammar),this.regexps=new e.regexps,this.translations=new e.translations;this.passage=new f(this.options,this.translations),this.regexps_manager=new d(this),this.translations_manager=new g(this)}parse(e){return this.reset(),e=this.matcher.replace_control_characters(e),[e,this.passage.books]=this.matcher.match_books(e),[this.entities]=this.matcher.match_passages(e),this}parse_with_context(e,t){this.reset(),[t,this.passage.books]=this.matcher.match_books(this.matcher.replace_control_characters(t));let s;return[s,t]=this.matcher.match_passages(t),this.reset(),e=this.matcher.replace_control_characters(e),[e,this.passage.books]=this.matcher.match_books(e),this.passage.books.push({value:"",parsed:"",start_index:0,type:"context",context:t}),e=""+(this.passage.books.length-1)+"/9"+e,[this.entities]=this.matcher.match_passages(e),this}reset(){this.entities=[],this.passage.books=[],this.passage.indices={}}set_options(e){e.include_apocrypha!=null&&(this.include_apocrypha(e.include_apocrypha),delete e.include_apocrypha);for(let[t,s]of Object.entries(e))typeof this.options[t]=="string"&&(this.options[t]=s);return this}include_apocrypha(e){let t=this.options.testaments,s=t;return e===!0&&t.indexOf("a")===-1?s=s+"a":e===!1&&t.indexOf("a")>=1&&(s=s.slice(0,-1)),s!==t&&(this.options.testaments=s),this}translation_info(e="default"){return this.translations_manager.translation_info(e)}osis(){let e=[];for(let t of this.parsed_entities())t.osis.length>0&&e.push(t.osis);return e.join(",")}osis_and_translations(){let e=[];for(let t of this.parsed_entities())t.osis.length>0&&e.push([t.osis,t.translations.join(",")]);return e}osis_and_indices(){let e=[];for(let t of this.parsed_entities())t.osis.length>0&&e.push({osis:t.osis,translations:t.translations,indices:t.indices});return e}parsed_entities(){let e=[];return this.entities.forEach((t,s)=>{if(t.type&&t.type==="translation_sequence"&&e.length>0&&s===e[e.length-1].entity_id+1&&(e[e.length-1].indices[1]=t.absolute_indices[1]),t.passages==null||t.type==="b"&&this.options.book_alone_strategy==="ignore"||t.type==="b_range"&&this.options.book_range_strategy==="ignore"||t.type==="context")return;let n=[],r="";if(t.passages[0].translations)for(let i of t.passages[0].translations){let o=i.osis&&i.osis.length>0?i.osis:"";r===""&&(r=i.system),n.push(o)}else n=[""],r="current";let a=this.parse_entity_passages(t,s,n,r);if(a.length!==0)if(a.length>1&&this.options.consecutive_combination_strategy==="combine"&&(a=this.combine_consecutive_passages(a,r)),this.options.sequence_combination_strategy==="separate")e=e.concat(a);else{let i=[],o=a.length-1;a[o].enclosed_indices&&a[o].enclosed_indices[1]>=0&&(t.absolute_indices[1]=a[o].enclosed_indices[1]);for(let l of a)l.osis.length>0&&i.push(l.osis);e.push({osis:i.join(","),indices:t.absolute_indices,translations:n,entity_id:s,entities:a})}}),e}parse_entity_passages(e,t,s,n){let r=[],a=e.passages.length,i=this.options.testaments.indexOf("o")>=0;return e.passages.forEach((o,l)=>{if(o.type||(o.type=e.type),!(o.valid.valid===!1&&(this.options.invalid_sequence_strategy==="ignore"&&e.type==="sequence"&&this.snap_sequence("ignore",e,r,l,a),this.options.invalid_passage_strategy==="ignore"))){if((o.type==="b"||o.type==="b_range")&&this.options.book_sequence_strategy==="ignore"&&e.type==="sequence"){this.snap_sequence("book",e,r,l,a);return}i===!1&&o.start.b==="Ps"&&o.start.c!=null&&o.start.c<151&&o.end.b==="Ps"&&o.end.c!=null&&o.end.c<151||((o.type==="b_range_start"||o.type==="range_end_b")&&this.options.book_range_strategy==="ignore"&&this.snap_range(e,l),o.absolute_indices||(o.absolute_indices=[...e.absolute_indices]),r.push({osis:o.valid.valid?this.to_osis(o.start,o.end,n):"",type:o.type,indices:o.absolute_indices,translations:s,start:o.start,end:o.end,enclosed_indices:o.enclosed_absolute_indices,entity_id:t,entities:[o]}))}}),r}to_osis(e,t,s){t.c==null&&t.v==null&&e.c==null&&e.v==null&&e.b===t.b&&this.options.book_alone_strategy==="first_chapter"&&(t.c=1);let n={start:"",end:""};e.c==null&&(e.c=1),e.v==null&&(e.v=1),this.options.versification_system.indexOf("a")>=0&&this.options.ps151_strategy==="b"&&(e.c===151&&e.b==="Ps"||t.c===151&&t.b==="Ps")&&this.fix_ps151(e,t,s);let r=this.passage.translations.systems[s]?.chapters[t.b]||this.passage.translations.systems.current.chapters[t.b];t.c==null&&(this.options.passage_existence_strategy.indexOf("c")>=0||r&&r.length===1?t.c=r.length:t.c=999),t.v==null&&(r&&r[t.c-1]&&this.options.passage_existence_strategy.indexOf("v")>=0?t.v=r[t.c-1]:t.v=999),this.options.osis_compaction_strategy==="b"&&e.c===1&&e.v===1&&(t.c===999&&t.v===999||t.c===r.length&&this.options.passage_existence_strategy.indexOf("c")>=0&&(t.v===999||t.v===r[t.c-1]&&this.options.passage_existence_strategy.indexOf("v")>=0))?(n.start=e.b,n.end=t.b):this.options.osis_compaction_strategy.length<=2&&e.v===1&&(t.v===999||t.v===r[t.c-1]&&this.options.passage_existence_strategy.indexOf("v")>=0)?(n.start=e.b+"."+e.c,n.end=t.b+"."+t.c):(n.start=e.b+"."+e.c+"."+e.v,n.end=t.b+"."+t.c+"."+t.v);let a="";return n.start===n.end?a=n.start:a=n.start+"-"+n.end,e.extra&&(a=e.extra+","+a),t.extra&&(a+=","+t.extra),a}fix_ps151(e,t,s){let n=this.options.versification_system;this.options.versification_system=s;let r=this.options.versification_system;e.c===151&&e.b==="Ps"?t.c===151&&t.b==="Ps"?(e.b="Ps151",e.c=1,t.b="Ps151",t.c=1):(e.extra=this.to_osis({b:"Ps151",c:1,v:e.v},{b:"Ps151",c:1,v:this.translations.systems.current.chapters.Ps151[0]},s),e.b="Prov",e.c=1,e.v=1):(t.extra=this.to_osis({b:"Ps151",c:1,v:1},{b:"Ps151",c:1,v:t.v},s),t.c=150,t.v=this.translations.systems.current.chapters.Ps[149]),n!==r&&(this.options.versification_system=n)}combine_consecutive_passages(e,t){let s=[],n={},r=e.length-1,a=-1,i=!1;return e.forEach((o,l)=>{if(o.osis.length>0){let c=s.length-1,_=!1;o.enclosed_indices[0]!==a&&(a=o.enclosed_indices[0]),a>=0&&(l===r||e[l+1].enclosed_indices[0]!==o.enclosed_indices[0])&&(_=!0,i=!0),this.is_verse_consecutive(n,o.start,t)?(s[c].end=o.end,s[c].is_enclosed_last=_,s[c].indices[1]=o.indices[1],s[c].enclosed_indices[1]=o.enclosed_indices[1],s[c].osis=this.to_osis(s[c].start,o.end,t)):s.push(o),n={b:o.end.b,c:o.end.c,v:o.end.v}}else s.push(o),n={}}),i&&this.snap_enclosed_indices(s),s}snap_enclosed_indices(e){for(let t of e)t.is_enclosed_last!=null&&(t.enclosed_indices[0]<0&&t.is_enclosed_last&&(t.indices[1]=t.enclosed_indices[1]),delete t.is_enclosed_last);return e}is_verse_consecutive(e,t,s){if(!e.b)return!1;let n=this.passage.translations.systems[s]?.order||this.passage.translations.systems.current.order,r=this.passage.translations.systems[s]?.chapters?.[e.b]||this.passage.translations.systems.current.chapters[e.b];if(e.b===t.b){if(e.c===t.c)return e.v===t.v-1;if(t.v===1&&e.c===t.c-1){let a=r[e.c-1];return e.v===a}}else if(t.c===1&&t.v===1&&n[e.b]===n[t.b]-1)return e.c===r.length&&e.v===r[e.c-1];return!1}snap_range(e,t){let s=0,n="start",r="range_end_b";e.original_type==="b_range_start"&&(e.type=e.original_type,delete e.original_type),(e.type==="b_range_start"||e.type==="sequence"&&e.passages[t].type==="b_range_start")&&(s=1,n="end",r="b_range_start");let a=n==="end"?"start":"end";for(let o of[n,a])e.passages[t][o].original_object!=null&&(e.passages[t][o]=e.passages[t][o].original_object);let i=structuredClone(e.passages[t][a]);if(e.passages[t][a]=structuredClone(e.passages[t][n]),e.passages[t][a].original_object=i,e.passages[t][n].original_object=structuredClone(e.passages[t][n]),e.type==="sequence"){t>=e.value.length&&(t=e.value.length-1);let o=this.passage.pluck(r,e.value[t]);if(o!=null){let l=this.snap_range(o,0);t===0?e.absolute_indices[0]=l.absolute_indices[0]:e.absolute_indices[1]=l.absolute_indices[1]}}else e.original_type=e.type,e.type=e.value[s].type,e.absolute_indices=[e.value[s].absolute_indices[0],e.value[s].absolute_indices[1]];return e}snap_sequence(e,t,s,n,r){let a=t.passages[n];a.absolute_indices[0]===t.absolute_indices[0]&&n<r-1&&this.get_snap_sequence_i(t.passages,n,r)!==n?(t.absolute_indices[0]=t.passages[n+1].absolute_indices[0],this.remove_absolute_indices(t.passages,n+1)):a.absolute_indices[1]===t.absolute_indices[1]&&n>0?t.absolute_indices[1]=s.length>0?s[s.length-1].indices[1]:t.passages[n-1].absolute_indices[1]:e==="book"&&n<r-1&&!this.starts_with_book(t.passages[n+1])&&(t.passages[n+1].absolute_indices[0]=a.absolute_indices[0])}get_snap_sequence_i(e,t,s){for(let n=t+1;n<s;n++){if(this.starts_with_book(e[n]))return n;if(e[n].valid.valid)return t}return t}starts_with_book(e){return!!(e.type.substring(0,1)==="b"||(e.type==="range"||e.type==="ff")&&e.start&&e.start.type&&e.start.type.substring(0,1)==="b")}remove_absolute_indices(e,t){if(e[t].enclosed_absolute_indices[0]<0)return;let[s,n]=e[t].enclosed_absolute_indices,r=e.length;for(let a of e.slice(t))if(a.enclosed_absolute_indices[0]===s&&a.enclosed_absolute_indices[1]===n)a.enclosed_absolute_indices=[-1,-1];else break}add_books(e){return this.regexps_manager.add_books(e)}add_translations(e){return this.translations_manager.add_translations(e)}};export{y as bcv_parser};
